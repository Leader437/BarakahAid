# ==========================================
# BarakahAid - Docker Compose Configuration
# ==========================================
# Usage:
#   Development: docker-compose up --build
#   Production:  docker-compose -f docker-compose.yml up -d
#
# Build with custom API URL:
#   docker-compose build --build-arg VITE_API_URL=https://api.yourdomain.com
# ==========================================

services:
  # ----------------------------------------
  # Backend API Server (NestJS)
  # ----------------------------------------
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: barakahaid-server
    restart: unless-stopped
    ports:
      - "${SERVER_PORT:-5500}:5500"
    environment:
      # Database
      - DATABASE_URL=${DATABASE_URL}
      
      # Frontend URLs (for CORS)
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
      - ADMIN_URL=${ADMIN_URL:-http://localhost:3001}
      
      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-1d}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN:-7d}
      
      # Node Environment
      - NODE_ENV=${NODE_ENV:-production}
      
      # Cloudinary
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
      
      # Stripe
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLIC_KEY=${STRIPE_PUBLIC_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      
      # Google OAuth
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_CALLBACK_URL=${GOOGLE_CALLBACK_URL}
    networks:
      - barakahaid-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5500/api/health', (r) => r.statusCode === 200 ? process.exit(0) : process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ----------------------------------------
  # Client Application (React/Vite)
  # ----------------------------------------
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL:-http://localhost:5500}
    container_name: barakahaid-client
    restart: unless-stopped
    ports:
      - "${CLIENT_PORT:-3000}:80"
    depends_on:
      server:
        condition: service_healthy
    networks:
      - barakahaid-network

  # ----------------------------------------
  # Admin Panel (React/Vite)
  # ----------------------------------------
  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL:-http://localhost:5500}
    container_name: barakahaid-admin
    restart: unless-stopped
    ports:
      - "${ADMIN_PORT:-3001}:80"
    depends_on:
      server:
        condition: service_healthy
    networks:
      - barakahaid-network

networks:
  barakahaid-network:
    driver: bridge
